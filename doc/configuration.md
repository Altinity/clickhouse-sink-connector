# Sink Connector Configuration Settings

## LightWeight Sink Connector

### Setting Values for Docker Operation

Update `config.yml` https://github.com/Altinity/clickhouse-sink-connector/blob/develop/sink-connector-lightweight/docker/config.yml

1.  Update **MySQL information** in config.yaml: `database.hostname`, `database.port`, `database.user` and `database.password`.
2.  Update **ClickHouse information** in config.yaml: `clickhouse.server.url`, `clickhouse.server.user`, `clickhouse.server.password`, `clickhouse.server.port`. 
Also Update **ClickHouse information** for the following fields that are used to store the offset information- `offset.storage.jdbc.url`, `offset.storage.jdbc.user`, `offset.storage.jdbc.password`, `schema.history.internal.jdbc.url`, `schema.history.internal.jdbc.user`, and `schema.history.internal.jdbc.password`.
3.  Update MySQL databases to be replicated: `database.include.list`.
4.  Add table filters: `table.include.list`.
5.  Set `snapshot.mode` to `initial` if you like to replicate existing records, set `snapshot.mode` to `schema_only` to replicate schema and only the records that are modified after the connector is started.
6.  Start replication by running the JAR file. `java -jar clickhouse-debezium-embedded-1.0-SNAPSHOT.jar <yaml_config_file>` or docker.
**ClickHouse HTTPS servers**
For `https` servers, make sure the `clickhouse.server.url` includes `https`
Also add `?ssl=true` and port `8443` to both the `offset.storage.jdbc.url` and `schema.history.internal.jdbc.url` configuration variables.
Example: **ClickHouse Cloud**
```
clickhouse.server.url: "https://cloud_url"
offset.storage.jdbc.url: "jdbc:clickhouse://cloud_url:8443/altinity_sink_connector?ssl=true"
schema.history.internal.jdbc.url: "jdbc:clickhouse://cloud_url:8443/altinity_sink_connector?ssl=true"
```

### MySQL Configuration 
[MySQL Configuration](sink-connector-lightweight/docker/config.yml)

### PostgreSQL Configuration
For AWS RDS users, you might need to add heartbeat interval and query to avoid WAL logs constantly growing in size.
https://stackoverflow.com/questions/76415644/postgresql-wal-log-limiting-rds
https://debezium.io/documentation/reference/stable/connectors/postgresql.html#postgresql-wal-disk-space

[PostgreSQL Configuration](sink-connector-lightweight/docker/config_postgres.yml)

### Configuration Reference
 Configuration                          | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
|----------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| database.hostname                      | Source Database HostName                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| database.port                          | Source Database Port number                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| database.user                          | Source Database Username(user needs to have replication permission, Refer https://debezium.io/documentation/reference/stable/connectors/mysql.html)                                                                                                          GRANT SELECT, RELOAD, SHOW DATABASES, REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 'user' IDENTIFIED BY 'password';                                                                                                                                                  |
| database.password                      | Source Database Password                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| database.include.list                  | List of databases to be included in replication.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| table.include.list                     | List of tables to be included in replication.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| clickhouse.server.url                  | ClickHouse URL, For TLS(use `https` and set port to `8443`)                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| clickhouse.server.user                 | ClickHouse username                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| clickhouse.server.password             | ClickHouse password                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| clickhouse.server.port                 | ClickHouse port, For TLS(use the correct port `8443` or `443`                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| clickhouse.server.database             | ClickHouse destination database                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| snapshot.mode                          | "initial" -> Data that already exists in source database will be replicated. "schema_only" -> Replicate data that is added/modified after the connector is started.\<br/> MySQL: https://debezium.io/documentation/reference/stable/connectors/mysql.html#mysql-property-snapshot-mode \ <br/>PostgreSQL: https://debezium.io/documentation/reference/stable/connectors/postgresql.html#postgresql-property-snapshot-mode  <br/> MongoDB: initial, never. https://debezium.io/documentation/reference/stable/connectors/mongodb.html |
| connector.class                        | MySQL -> "io.debezium.connector.mysql.MySqlConnector" <br/> PostgreSQL -> <br/> Mongo ->   <br/>                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| offset.storage.file.filename           | Offset storage file(This stores the offsets of the source database) MySQL: mysql binlog file and position, gtid set. Make sure this file is durable and its not persisted in temp directories.                                                                                                                                                                                                                                                                                                                                       |
| database.history.file.filename         | Database History: Make sure this file is durable and its not persisted in temp directories.                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| schema.history.internal.file.filename  | Schema History: Make sure this file is durable and its not persisted in temp directories.                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| disable.ddl                            | **Optional**, Default: false, if DDL execution needs to be disabled                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| enable.ddl.snapshot                    | **Optional**, Default: false, If set to true, the DDL that is passed as part of snapshot process will be executed. Default behavior is DROP/TRUNCATE as part of snapshot is disabled.                                                                                                                                                                                                                                                                                                                                                |
| database.allowPublicKeyRetrieval       | **Optional**, MySQL specific: true/false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| auto.create.tables                     | When True, connector will create tables(transformed DDL from source)                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| persist.raw.bytes                      | Debezium.BYTES data(usually UUID) is persisted as raw bytes(CH String) if set to true.                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| database.connectionTimeZone            | Example: "US/Samoa,  Specify MySQL timezone for DATETIME conversions.https://debezium.io/documentation/reference/stable/connectors/mysql.html#mysql-temporal-types                                                                                                                                                                                                                                                                                                                                                                   |
| enable.snapshot.ddl                    | When true, pre-existing DDL statements from source(MySQL) will be executed. Warning: This might run DROP TABLE commands.                                                                                                                                                                                                                                                                                                                                                                                                             |
| clickhouse.datetime.timezone           | Override timezone for DateTime columns in ClickHouse server.                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| skip_replica_start                     | If set to true, replication is not started, the user is expected to start replication with the sink-connector-client program.                                                                                                                                                                                                                                                                                                                                                                                                        |
| restart.event.loop                     | If set to true, replication will be re-started based on the restart.event.loop.timeout.period parameter(which is defined in seconds)                                                                                                                                                                                                                                                                                                                                                                                                 |
| restart.event.loop.timeout.period.secs | If the last change record(CDC) received from source database exceeds this threshold period defined in seconds, then replication is restarted.                                                                                                                                                                                                                                                                                                                                                                                        |
| batch.max.records                      | Size of the batch that is persisted to ClickHouse.(Default 100000)                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |



## Kafka Sink Connector for ClickHouse

### Recommended Memory limits.
**Production Usage**
In `docker-compose.yml` file, its recommended to set Xmx to atleast 5G `-Xmx5G` when using in Production and 
if you encounter a `Out of memory/Heap exception` error. 
for both **Debezium** and **Sink**

```
- KAFKA_HEAP_OPTS=-Xms2G -Xmx5G
```

### Kafka Sink Connector Configuration

|  Property                        |   Default | Description                                                                                                                                                           |
|----------------------------------|-----------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| tasks.max                        | No        | SinkConnector task(essentially threads), ideally this needs to be the same as the Kafka partitions.                                                                   |
| topics.regex                     | No        | Regex of matching topics.  Example: "SERVER5432.test.(.*)" matches SERVER5432.test.employees and SERVER5432.test.products                                             |
| topics                           | No        | The list of topics. topics or topics.regex has to be provided.                                                                                                        |
| clickhouse.server.url            |           | ClickHouse Server URL                                                                                                                                                 |
| clickhouse.server.user           |           | ClickHouse Server username                                                                                                                                            |
| clickhouse.server.password           |           | ClickHouse Server password                                                                                                                                            |
| clickhouse.server.database       |           | ClickHouse Database name                                                                                                                                              |
| clickhouse.server.port           | 8123      | ClickHouse Server port                                                                                                                                                |
| clickhouse.topic2table.map       | No        | Map of Kafka topics to table names, <topic_name1>:<table_name1>,<topic_name2>:<table_name2> This variable will override the default mapping of topics to table names. |
| store.kafka.metadata             | false     | If set to true, kafka metadata columns will be added to Clickhouse                                                                                                    |
| store.raw.data                   | false     | If set to true, the entire row is converted to JSON and stored in the column defined by the  ` store.raw.data.column ` field                                          |
| store.raw.data.column            | No        | Clickhouse table column to store the raw data in JSON form(String Clickhouse DataType)                                                                                |
| metrics.enable                   | true      | Enable Prometheus scraping                                                                                                                                            |
| metrics.port                     | 8084      | Metrics port                                                                                                                                                          |
| buffer.flush.time.ms             | 30        | Buffer(Batch of records) flush time in milliseconds                                                                                                                   |
| thread.pool.size                 | 10        | Number of threads that is used to connect to ClickHouse                                                                                                               |
| auto.create.tables               | false     | Sink connector will create tables in ClickHouse (If it does not exist)                                                                                                |
| snowflake.id                     | true      | Uses SnowFlake ID(Timestamp + GTID) as the version column for ReplacingMergeTree                                                                                      |
| replacingmergetree.delete.column | "sign"    | Column used as the sign column for ReplacingMergeTree.
